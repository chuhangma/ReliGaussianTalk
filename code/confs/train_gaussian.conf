# ============================================
# Relightable 3D Gaussian Splatting - Obama
# Stage 1 & Stage 2 Training Configuration
# ============================================

train{
    # Experiment output folder
    exps_folder = ../data/experiments/
    methodname = GaussianRelight
    
    # TensorBoard log directory (leave empty to use default: {exps_folder}/{subject}/tensorboard)
    tensorboard_dir = ../data/tensorboard_logs/
    
    # Dataset and model classes (for Gaussian training)
    dataset_class = datasets.gaussian_dataset.GaussianRelightDataset
    model_class = scene.relightable_gaussian_model.RelightableGaussianModel
    
    # Learning rates
    learning_rate = 1.0e-3
    learning_rate_position = 1.6e-4
    learning_rate_feature = 2.5e-3
    learning_rate_opacity = 5.0e-2
    learning_rate_scaling = 5.0e-3
    learning_rate_rotation = 1.0e-3
    learning_rate_sh = 2.5e-3
    learning_rate_normal = 1.0e-3
    learning_rate_albedo = 5.0e-3
    learning_rate_roughness = 1.0e-3
    learning_rate_specular = 1.0e-3
    
    # Training parameters
    batch_size = 256
    num_workers = 16
    
    # Gaussian densification
    densify_from_iter = 500
    densify_until_iter = 15000
    densification_interval = 100
    opacity_reset_interval = 3000
    densify_grad_threshold = 0.0002
    
    # Learning rate decay
    position_lr_max_steps = 30000
    
    # Plot/save frequency
    plot_freq = 10
    save_freq = 50
}

plot{
    plot_nimgs = 4
    max_depth = 6.0
    min_depth = 2.0
}

loss{
    # RGB reconstruction loss
    rgb_weight = 1.0
    
    # Perceptual loss (VGG)
    perceptual_weight = 0.1
    
    # SSIM loss
    ssim_weight = 0.2
    
    # Mask loss
    mask_weight = 10.0
    
    # Normal consistency loss
    normal_weight = 0.05
    
    # Regularization
    opacity_reg_weight = 0.01
    scale_reg_weight = 0.01
    
    # Semantic segmentation guidance
    gt_w_seg = True
}

dataset{
    data_folder = ../data/datasets
    subject_name = Obama
    json_name = flame_params.json
    
    train{
        sub_dir = [Obama_train]
        img_res = [512, 512]
        subsample = 1
    }
    
    test{
        sub_dir = [Obama_train]  # Use same for evaluation during training
        img_res = [512, 512]
        subsample = 50
    }
}

model{
    # Gaussian initialization mode
    # use_mesh_vertices = true: Use exact mesh vertices from FLAME (recommended, follows GaussianTalker)
    #                           This gives ~5023 Gaussians for FLAME, ~34650 for BFM
    # use_mesh_vertices = false: Use num_gaussians random samples (legacy mode)
    use_mesh_vertices = true
    
    # Number of initial Gaussians (only used if use_mesh_vertices = false)
    num_gaussians = 50000
    
    # Gaussian parameters
    sh_degree = 3  # Spherical harmonics degree
    
    # Feature dimensions
    feature_dim = 32
    
    # Enable motion/deformation network for talking head animation
    with_motion_net = false  # Set to true if you want expression-driven deformation
    
    # FLAME model path (relative to code/ directory)
    flame_model_path = flame/FLAME2020/generic_model.pkl
    
    # Appearance network
    appearance_network{
        d_in = 32
        d_out = 3
        dims = [64, 64]
        weight_norm = True
    }
    
    # Normal prediction network
    normal_network{
        d_in = 32
        d_out = 3
        dims = [64, 64]
        weight_norm = True
    }
    
    # Material network (for Stage 2 relighting)
    material_network{
        d_in = 32
        d_out = 6  # albedo(3) + roughness(1) + specular(2)
        dims = [64, 64, 64]
        weight_norm = True
    }
}

# Stage-specific settings
stage1{
    # Focus on geometry learning
    nepochs = 200
    
    # Disable material network
    use_material = False
    
    # Loss weights
    rgb_weight = 1.0
    mask_weight = 10.0
}

stage2{
    # Focus on relighting/material learning
    nepochs = 100
    
    # Enable material network
    use_material = True
    
    # Loss weights for relighting
    rgb_weight = 1.0
    albedo_weight = 0.1
    shading_weight = 0.1
    specular_weight = 0.05
}
